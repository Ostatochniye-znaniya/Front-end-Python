<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>Входящие заявки (2.6)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <div class="stage">
        <div class="viewport">
            <div class="panel">

                <h1 class="h1">Входящие заявки (2.6)</h1>

                <!-- ФИЛЬТРЫ (ЗАДАЧА 4) -->
                <div style="display:flex;gap:16px;margin-bottom:16px;">
                    <div>
                        <label>Статус:</label><br>
                        <select id="filter-status">
                            <option value="all">Все</option>
                            <option value="requested">Ожидает назначения</option>
                            <option value="approved">Назначено</option>
                        </select>
                    </div>

                    <div>
                        <label>Подразделение:</label><br>
                        <select id="filter-subdivision">
                            <option value="all">Все</option>
                            {% for r in requests %}
                            <option value="{{ r.from_subdivision }}">{{ r.from_subdivision }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <table class="groups">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>От подразделения</th>
                            <th>Группа</th>
                            <th>Дисциплина</th>
                            <th>Статус</th>
                            <th>Действие</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for r in requests %}
                        <tr data-status="{{ r.status }}" data-subdivision="{{ r.from_subdivision }}">
                            <td>{{ r.id }}</td>
                            <td>{{ r.from_subdivision }}</td>
                            <td>{{ r.group }}</td>
                            <td>{{ r.discipline }}</td>

                            <!-- СТАТУС С БЕЙДЖЕМ -->
                            <td>
                                {% if r.status == 'requested' %}
                                <span
                                    style="padding:4px 8px;border-radius:6px;background:#fff3cd;color:#856404;font-size:13px;font-weight:600;">
                                    Ожидает назначения
                                </span>
                                {% elif r.status == 'approved' %}
                                <span
                                    style="padding:4px 8px;border-radius:6px;background:#e6fffa;color:#065f46;font-size:13px;font-weight:600;">
                                    Назначено
                                </span>
                                {% else %}
                                <span
                                    style="padding:4px 8px;border-radius:6px;background:#e2e3e5;color:#383d41;font-size:13px;font-weight:600;">
                                    Неизвестно
                                </span>
                                {% endif %}
                            </td>

                            <td>
                                {% if r.status == 'requested' %}
                                <button class="btn" onclick="openModal({{ r.id }})">
                                    Открыть
                                </button>
                                {% else %}
                                ✔ Обработано
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
        </div>
    </div>

    <!-- МОДАЛКА -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">

            <h2>Обработка заявки</h2>

            <form method="post">

                <input type="hidden" name="request_id" id="modal_request_id">

                <label>Назначить преподавателя:</label>
                <select name="teacher" required>
                    <option value="">Выберите...</option>
                    {% for t in teachers %}
                    <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                </select>

                <label>Дата проведения:</label>
                <input type="date" name="date" required>

                <label>Время проведения:</label>
                <input type="time" name="time" required>

                <button class="btn" type="submit">Утвердить</button>
                <button class="btn" type="button" onclick="closeModal()">Закрыть</button>

            </form>
        </div>
    </div>

    <!-- ТВОЙ JS — БЕЗ ИЗМЕНЕНИЙ -->
    <script>
        function openModal(id) {
            document.getElementById("modal_request_id").value = id;
            document.getElementById("modal").classList.remove("hidden");
        }

        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }

        // ФИЛЬТРАЦИЯ (ЗАДАЧА 4)
        const statusFilter = document.getElementById("filter-status");
        const subdivisionFilter = document.getElementById("filter-subdivision");

        function applyFilters() {
            const status = statusFilter.value;
            const subdivision = subdivisionFilter.value;

            document.querySelectorAll("tbody tr").forEach(row => {
                const rowStatus = row.dataset.status;
                const rowSubdivision = row.dataset.subdivision;

                let visible = true;

                if (status !== "all" && rowStatus !== status) visible = false;
                if (subdivision !== "all" && rowSubdivision !== subdivision) visible = false;

                row.style.display = visible ? "" : "none";
            });
        }

        statusFilter.addEventListener("change", applyFilters);
        subdivisionFilter.addEventListener("change", applyFilters);
    </script>

</body>

</html>
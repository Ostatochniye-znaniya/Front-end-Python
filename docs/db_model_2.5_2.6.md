# Модель данных для подпунктов 2.5–2.6 Приказа (проверка остаточных знаний)

Документ описывает сущности и связи, необходимые для реализации процессов из пунктов **2.5–2.6** ТЗ:

- выбор групп и дисциплин для проверки остаточных знаний;
- планирование проверки (назначение ответственных, даты и времени);
- оформление заявок на проведение проверки силами других подразделений;
- обработка входящих заявок;
- формирование графика проверок.

Документ носит характер **логической модели** и может быть адаптирован под фактическую структуру общей БД проекта.

## 1. Список сущностей

### 1.1. Общие справочники (скорее всего уже существуют или берутся из учебной БД)

1. `subdivisions` – Подразделения (факультеты / институты).
2. `departments` – Кафедры.
3. `disciplines` – Дисциплины.
4. `teachers` – Преподаватели.
5. `study_groups` – Учебные группы.

### 1.2. Сущности, относящиеся непосредственно к 2.5–2.6

6. `knowledge_checks` – Конкретные проверки остаточных знаний для пары «группа + дисциплина».
7. `foreign_requests` – Заявки на проведение проверки силами подразделения другого факультета / института.

При необходимости позже могут быть добавлены дополнительные сущности (например, история статусов), но для покрытия требований 2.5–2.6 достаточно этих таблиц.

## 2. Описание сущностей и их атрибутов

### 2.1. Таблица `subdivisions` (Подразделения)

Используется для хранения факультетов и институтов, участвующих в процессе.

| Поле               | Тип             | Обяз. | Описание |
|--------------------|-----------------|------|----------|
| `id`               | INT, PK         | Да   | Идентификатор подразделения. |
| `code`             | VARCHAR(32)     | Да   | Короткий код подразделения (например, `ФИТ`). |
| `name`             | VARCHAR(255)    | Да   | Полное наименование (например, «Факультет информационных технологий»). |
| `type`             | ENUM('faculty', 'institute') | Да | Тип подразделения. |
| `is_active`        | BOOLEAN         | Да   | Признак актуальности записи. |

### 2.2. Таблица `departments` (Кафедры)

Кафедра всегда принадлежит какому-то подразделению (факультету/институту).

| Поле               | Тип         | Обяз. | Описание |
|--------------------|------------|------|----------|
| `id`               | INT, PK     | Да   | Идентификатор кафедры. |
| `subdivision_id`   | INT, FK -> `subdivisions.id` | Да | Подразделение, к которому относится кафедра. |
| `code`             | VARCHAR(32) | Да   | Код кафедры (например, `ИКТ`). |
| `name`             | VARCHAR(255)| Да   | Наименование кафедры. |
| `is_active`        | BOOLEAN     | Да   | Признак актуальности записи. |

### 2.3. Таблица `disciplines` (Дисциплины)

Каждая дисциплина закреплена за конкретной кафедрой.

| Поле               | Тип         | Обяз. | Описание |
|--------------------|------------|------|----------|
| `id`               | INT, PK     | Да   | Идентификатор дисциплины. |
| `code`             | VARCHAR(64) | Да   | Код дисциплины (по учебному плану). |
| `name`             | VARCHAR(255)| Да   | Наименование дисциплины. |
| `department_id`    | INT, FK -> `departments.id` | Да | Кафедра, за которой закреплена дисциплина. |
| `is_active`        | BOOLEAN     | Да   | Признак актуальности записи. |

### 2.4. Таблица `teachers` (Преподаватели)

Преподаватель привязан к кафедре (основное место работы).

| Поле               | Тип         | Обяз. | Описание |
|--------------------|------------|------|----------|
| `id`               | INT, PK     | Да   | Идентификатор преподавателя. |
| `full_name`        | VARCHAR(255)| Да   | ФИО преподавателя. |
| `department_id`    | INT, FK -> `departments.id` | Да | Кафедра. |
| `email`            | VARCHAR(255)| Нет  | Контактный e-mail (для уведомлений). |
| `is_active`        | BOOLEAN     | Да   | Признак актуальности записи. |

### 2.5. Таблица `study_groups` (Учебные группы)

Группа закреплена за факультетом/институтом (подразделением), может иметь направление/профиль подготовки.

| Поле                | Тип          | Обяз. | Описание |
|---------------------|-------------|------|----------|
| `id`                | INT, PK      | Да   | Идентификатор группы. |
| `code`              | VARCHAR(32)  | Да   | Обозначение группы (например, `221-321`). |
| `direction_code`    | VARCHAR(32)  | Нет  | Код направления (например, `09.03.01`). |
| `profile_name`      | VARCHAR(255) | Нет  | Наименование профиля (как в таблице ФИТ). |
| `subdivision_id`    | INT, FK -> `subdivisions.id` | Да | Факультет/институт, к которому относится группа. |
| `education_level`   | VARCHAR(64)  | Нет  | Уровень образования (бакалавр, специалист и т. п.). |
| `admission_year`    | SMALLINT     | Нет  | Год набора (для сервисных целей). |
| `is_active`         | BOOLEAN      | Да   | Признак актуальности записи. |

### 2.6. Таблица `knowledge_checks` (Проверки остаточных знаний)

Основная сущность для планирования и фиксации проверки остаточных знаний для пары «группа + дисциплина».

| Поле                       | Тип                | Обяз. | Описание |
|----------------------------|--------------------|------|----------|
| `id`                       | INT, PK            | Да   | Идентификатор проверки. |
| `study_group_id`           | INT, FK -> `study_groups.id` | Да | Группа, в которой проводится проверка. |
| `discipline_id`            | INT, FK -> `disciplines.id` | Да | Дисциплина, по которой проводится проверка. |
| `requesting_subdivision_id`| INT, FK -> `subdivisions.id` | Да | Подразделение-инициатор (обычно факультет группы). |
| `performing_department_id` | INT, FK -> `departments.id`  | Нет | Кафедра, фактически проводящая проверку (может совпадать с кафедрой дисциплины). |
| `responsible_teacher_id`   | INT, FK -> `teachers.id`     | Нет | Ответственный преподаватель. |
| `scheduled_date`           | DATE               | Нет  | Дата проведения проверки. |
| `scheduled_time`           | TIME               | Нет  | Время проведения проверки. |
| `status`                   | ENUM('draft', 'internal_planned', 'external_requested', 'external_assigned', 'confirmed', 'completed', 'cancelled') | Да | Статус проверки (см. ниже). |
| `created_at`               | DATETIME           | Да   | Дата создания записи. |
| `updated_at`               | DATETIME           | Да   | Дата последнего изменения записи. |

Возможная интерпретация статусов:

- `draft` – черновик, заведующий кафедрой выбирает группы и дисциплины (п. 2.5.1).  
- `internal_planned` – для «своей» дисциплины назначены преподаватель, дата и время.  
- `external_requested` – для «чужой» дисциплины создана заявка в другое подразделение (п. 2.5.2).  
- `external_assigned` – подразделение-исполнитель назначило своего преподавателя и время.  
- `confirmed` – проверка согласована с преподавателем и включена в график (п. 2.6).  
- `completed` – проверка проведена, отчёт загружен.  
- `cancelled` – проверка отменена.

### 2.7. Таблица `foreign_requests` (Заявки в другие подразделения)

Используется для фиксации заявок, отправляемых между подразделениями, когда дисциплина закреплена за кафедрой другого факультета/института.

| Поле                       | Тип                | Обяз. | Описание |
|----------------------------|--------------------|------|----------|
| `id`                       | INT, PK            | Да   | Идентификатор заявки. |
| `knowledge_check_id`       | INT, FK -> `knowledge_checks.id` | Да | Связь с конкретной проверкой (группа + дисциплина). |
| `from_subdivision_id`      | INT, FK -> `subdivisions.id` | Да | Подразделение-инициатор (кто отправляет заявку). |
| `to_subdivision_id`        | INT, FK -> `subdivisions.id` | Да | Подразделение-исполнитель (кому отправляют). |
| `status`                   | ENUM('sent', 'in_review', 'accepted', 'rejected') | Да | Статус заявки. |
| `request_comment`          | TEXT               | Нет  | Комментарий/пожелания инициатора (например, желаемые даты). |
| `response_comment`         | TEXT               | Нет  | Комментарий подразделения-исполнителя (уточнения, причины отказа и т. п.). |
| `assigned_teacher_id`      | INT, FK -> `teachers.id` | Нет | Назначенный со стороны исполняющего подразделения преподаватель. |
| `assigned_date`            | DATE               | Нет  | Предложенная дата проведения проверки. |
| `assigned_time`            | TIME               | Нет  | Предложенное время проведения проверки. |
| `created_at`               | DATETIME           | Да   | Дата создания заявки. |
| `updated_at`               | DATETIME           | Да   | Дата последнего изменения заявки. |

Логика взаимодействия:

1. Инициирующее подразделение создаёт `knowledge_checks` и `foreign_requests` со статусом `sent`.  
2. Подразделение-исполнитель просматривает `foreign_requests`, назначает преподавателя и дату/время, переводит статус в `accepted`.  
3. После принятия заявки поля `assigned_teacher_id`, `assigned_date`, `assigned_time` могут быть синхронизированы с `knowledge_checks.responsible_teacher_id`, `scheduled_date`, `scheduled_time`, а статус проверки переводится в `external_assigned`/`confirmed`.

## 3. Связи между сущностями

Краткое описание основных связей:

1. **Подразделения и кафедры**  
   - `departments.subdivision_id` → `subdivisions.id`  
   Одна запись в `subdivisions` связана с несколькими кафедрами.

2. **Кафедры и дисциплины**  
   - `disciplines.department_id` → `departments.id`  
   Каждая дисциплина закреплена за одной кафедрой.

3. **Кафедры и преподаватели**  
   - `teachers.department_id` → `departments.id`  
   Каждый преподаватель относится к одной кафедре.

4. **Подразделения и учебные группы**  
   - `study_groups.subdivision_id` → `subdivisions.id`  
   Группа закреплена за одним факультетом/институтом.

5. **Проверки и базовые справочники**  
   - `knowledge_checks.study_group_id` → `study_groups.id`  
   - `knowledge_checks.discipline_id` → `disciplines.id`  
   - `knowledge_checks.requesting_subdivision_id` → `subdivisions.id`  
   - `knowledge_checks.performing_department_id` → `departments.id` (опционально)  
   - `knowledge_checks.responsible_teacher_id` → `teachers.id` (опционально)

6. **Заявки и проверки**  
   - `foreign_requests.knowledge_check_id` → `knowledge_checks.id`  
   Одна проверка может иметь одну активную заявку в другое подразделение (обычный кейс); при необходимости можно расширить до нескольких, введя дополнительные ограничения.

7. **Заявки и подразделения**  
   - `foreign_requests.from_subdivision_id` → `subdivisions.id`  
   - `foreign_requests.to_subdivision_id` → `subdivisions.id`

## 4. Определение «своей» и «чужой» дисциплины

Для определения, является ли дисциплина «своей» для подразделения, использующего систему, применяется следующая логика:

1. Для дисциплины берём её кафедру:  
   `disciplines.department_id` → `departments.id`.
2. Для кафедры берём её подразделение (факультет/институт):  
   `departments.subdivision_id` → `subdivisions.id`.  
   Это **владелец дисциплины**.
3. Сравниваем `departments.subdivision_id` с `knowledge_checks.requesting_subdivision_id`:
   - если значения **совпадают**, дисциплина считается **своей** для инициирующего подразделения;  
   - если значения **различаются**, дисциплина считается **чужой**, и для неё должна создаваться запись в `foreign_requests`.

Эта логика используется:

- на фронте — для выбора сценария (сразу назначать преподавателя или формировать заявку);  
- в отчётах — для разделения проверок на проводимые своими силами и силами других подразделений.

## 5. Ограничения целостности и индексы

### 5.1. Ограничения

1. Все PK-поля (`id`) должны иметь ограничения `PRIMARY KEY` и автоинкремент.  
2. Все FK-поля (`*_id`) должны иметь ограничения `FOREIGN KEY` с политикой `ON UPDATE CASCADE`.  
3. Для полей, которые не могут быть пустыми по бизнес-логике, задаётся `NOT NULL`:
   - `disciplines.department_id`,
   - `teachers.department_id`,
   - `study_groups.subdivision_id`,
   - `knowledge_checks.study_group_id`,
   - `knowledge_checks.discipline_id`,
   - `knowledge_checks.requesting_subdivision_id`,
   - `foreign_requests.knowledge_check_id`,
   - `foreign_requests.from_subdivision_id`,
   - `foreign_requests.to_subdivision_id`,
   - `status`-поля во всех таблицах.

4. Возможные дополнительные ограничения:
   - уникальность кода подразделения (`subdivisions.code`),
   - уникальность кода кафедры в пределах подразделения (`department.code`, `subdivision_id`),
   - уникальность сочетания (`study_group_id`, `discipline_id`) в `knowledge_checks` в рамках одного периода проведения проверки (если в системе будет понятие периода/семестра).

### 5.2. Индексы

Для ускорения выборок и фильтрации рекомендуется добавить индексы:

1. `knowledge_checks`:
   - индекс по `status` (фильтрация по состоянию проверки),
   - индекс по `scheduled_date` (построение графика),
   - индекс по `responsible_teacher_id`,
   - составной индекс (`study_group_id`, `discipline_id`).

2. `foreign_requests`:
   - индекс по `to_subdivision_id` + `status` (просмотр входящих заявок для подразделения-исполнителя),
   - индекс по `from_subdivision_id` (история исходящих заявок).

3. В справочниках:
   - индексы по `code` для быстрого поиска (подразделения, кафедры, дисциплины, группы).

---

Документ можно использовать как основу для:

- согласования структуры с преподавателем / архитектором проекта;
- описания требований к миграциям БД;
- обоснования полей в API и интерфейсах, реализующих подпункты 2.5–2.6.

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Формирование списка рекомендуемых групп</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="stage">
      <div class="viewport" style="width:1370px;height:890px;">
          <div class="panel">

              <h1 class="h1">Формирование списка рекомендуемых групп</h1>

              <form method="post" class="form" enctype="application/x-www-form-urlencoded" id="mainForm">

                  <div class="top-filters">
                      <div class="filter-row">
                          <div class="filter-item">
                            <label for="faculty" class="filter-labfa">Факультет/институт:</label>
                            <div class="select">
                                <select name="faculty" id="faculty">
                                    <option>ФИТ</option>
                                </select>
                                <span class="caret">▾</span>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label for="direction" class="filter-labdi">Направление:</label>
                            <div class="select">
                                <select name="direction" id="direction">
                                    <option>ИСИТ</option>
                                </select>
                                <span class="caret">▾</span>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label for="year" class="filter-labye">Учебный год:</label>
                            <div class="select">
                                <select name="year" id="year">
                                    <option>Весна</option>
                                </select>
                                <span class="caret">▾</span>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label for="semester" class="filter-labse">Семестр:</label>
                            <div class="select">
                                <select name="semester" id="semester">
                                    <option>2025</option>
                                </select>
                                <span class="caret">▾</span>
                            </div>
                        </div>
                      </div>
                  </div>

                  <div class="table-area">
                      <table class="groups">
                          <thead>
                              <tr>
                                  <th>Группа</th>
                                  <th>Курс</th>
                                  <th>Предыдущие тестирования</th>
                                  <th>Текущее тестирование</th>
                                  <th>Запланировать тестирование</th>
                              </tr>
                              <tr class="sub-header">
                                  <th></th>
                                  <th></th>
                                  <th>
                                      <div class="periods">
                                          <span>весна 2023</span>
                                          <span>осень 2023</span>
                                          <span>весна 2024</span>
                                      </div>
                                  </th>
                                  <th>весна 2025</th>
                                  <th>
                                      <div class="periods">
                                          <span>осень 2025</span>
                                          <span>весна 2026</span>
                                      </div>
                                  </th>
                              </tr>
                          </thead>

                          <tbody>
                              {% for g in groups %}
                              <tr class="{% if loop.index % 2 == 1 %}odd-row{% else %}even-row{% endif %}">
                                  <td class="group-id">{{ g.id }}</td>
                                  <td class="course">{{ g.course }}</td>

                                  <!-- Предыдущие: три независимых чекбокса -->
                                  <td class="prev-col">
                                      <div class="controls-row">
                                            <label class="square-toggle" title="весна 2023" for="prev_{{ g.id }}_v23">
                                                <input type="checkbox" name="prev_{{ g.id }}_v23" id="prev_{{ g.id }}_v23" {% if g.prev[0] %}checked{% endif %}>
                                                <span class="sq">
                                                  <svg class="icon-check" viewBox="0 0 24 24"><path fill="#fff" d="M20.285 6.709l-11.285 11.29-5.285-5.29 1.414-1.414 3.871 3.876 9.871-9.882z"/></svg>
                                                  <svg class="icon-cross" viewBox="0 0 24 24"><path fill="#fff" d="M18.3 5.71l-1-1L12 9l-5.3-4.29-1 1L11 10l-5.3 4.29 1 1L12 11l5.3 4.29 1-1L13 10z"/></svg>
                                                </span>
                                            </label>

                                          <label class="square-toggle" title="осень 2023" for="prev_{{ g.id }}_o23">
                                              <input type="checkbox" name="prev_{{ g.id }}_o23" id="prev_{{ g.id }}_o23" {% if g.prev[1] %}checked{% endif %}>
                                              <span class="sq">
                                                  <svg class="icon-check" viewBox="0 0 24 24"><path fill="#fff" d="M20.285 6.709l-11.285 11.29-5.285-5.29 1.414-1.414 3.871 3.876 9.871-9.882z"/></svg>
                                                  <svg class="icon-cross" viewBox="0 0 24 24"><path fill="#fff" d="M18.3 5.71l-1-1L12 9l-5.3-4.29-1 1L11 10l-5.3 4.29 1 1L12 11l5.3 4.29 1-1L13 10z"/></svg>
                                              </span>
                                          </label>

                                          <label class="square-toggle" title="весна 2024" for="prev_{{ g.id }}_v24">
                                              <input type="checkbox" name="prev_{{ g.id }}_v24" id="prev_{{ g.id }}_v24" {% if g.prev[2] %}checked{% endif %}>
                                              <span class="sq">
                                                  <svg class="icon-check" viewBox="0 0 24 24"><path fill="#fff" d="M20.285 6.709l-11.285 11.29-5.285-5.29 1.414-1.414 3.871 3.876 9.871-9.882z"/></svg>
                                                  <svg class="icon-cross" viewBox="0 0 24 24"><path fill="#fff" d="M18.3 5.71l-1-1L12 9l-5.3-4.29-1 1L11 10l-5.3 4.29 1 1L12 11l5.3 4.29 1-1L13 10z"/></svg>
                                              </span>
                                          </label>
                                      </div>
                                  </td>

                                  <!-- Текущее: один чекбокс -->
                                  <td class="current-col">
                                      <div class="controls-row center">
                                          <label class="square-toggle" title="текущее тестирование">
                                              <input type="checkbox" name="cur_{{ g.id }}" {% if g.current %}checked{% endif %}>
                                              <span class="sq">
                                                  <svg class="icon-check" viewBox="0 0 24 24"><path fill="#fff" d="M20.285 6.709l-11.285 11.29-5.285-5.29 1.414-1.414 3.871 3.876 9.871-9.882z"/></svg>
                                                  <svg class="icon-cross" viewBox="0 0 24 24"><path fill="#fff" d="M18.3 5.71l-1-1L12 9l-5.3-4.29-1 1L11 10l-5.3 4.29 1 1L12 11l5.3 4.29 1-1L13 10z"/></svg>
                                              </span>
                                          </label>
                                      </div>
                                  </td>

                                  <!-- Запланировать: квадраты с синей галочкой (radio -> только один) -->
                                  <td class="plan-col">
                                      <div class="plan-controls">
                                          <label class="plan-square" title="Осень 2025">
                                              <input type="radio" name="plan_{{ g.id }}" value="aut25" {% if g.plan == 'aut25' %}checked{% endif %}>
                                              <span class="sq-plan"><svg class="plan-check" viewBox="0 0 24 24"><path fill="#fff" d="M20.285 6.709l-11.285 11.29-5.285-5.29 1.414-1.414 3.871 3.876 9.871-9.882z"/></svg>
                                              </span>
                                          </label>

                                          <label class="plan-square" title="Весна 2026">
                                              <input type="radio" name="plan_{{ g.id }}" value="spr26" {% if g.plan == 'spr26' %}checked{% endif %}>
                                              <span class="sq-plan">
                                                  <svg class="plan-check" viewBox="0 0 24 24"><path fill="#fff" d="M20.285 6.709l-11.285 11.29-5.285-5.29 1.414-1.414 3.871 3.876 9.871-9.882z"/></svg>
                                              </span>
                                          </label>
                                      </div>
                                  </td>
                              </tr>
                              {% endfor %}
                          </tbody>
                      </table>
                  </div>

                  <div class="action">
                      <input class="btn" type="submit" value="Сформировать">
                  </div>
              </form>

          </div>
      </div>
  </div>
  <div class="modal-overlay" id="subjectModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Выбор дисциплин для группы <span class="modal-group-id" id="modalGroupId"></span></h3>
            </div>
            <div class="modal-content">
                <div class="select-row">
                    <div class="select-wrapper">
                        <label>Дисциплина 1</label>
                        <select class="modal-select" id="subject1">
                            <option value="">Выберите дисциплину</option>
                            <option value="math">Математика</option>
                            <option value="physics">Физика</option>
                            <option value="programming">Программирование</option>
                            <option value="algorithms">Алгоритмы и структуры данных</option>
                            <option value="databases">Базы данных</option>
                            <option value="networks">Компьютерные сети</option>
                            <option value="english">Английский язык</option>
                            <option value="economics">Экономика</option>
                        </select>
                        <span class="modal-caret">▾</span>
                    </div>
                    <div class="select-wrapper">
                        <label>Дисциплина 2</label>
                        <select class="modal-select" id="subject2">
                            <option value="">Выберите дисциплину</option>
                            <option value="math">Математика</option>
                            <option value="physics">Физика</option>
                            <option value="programming">Программирование</option>
                            <option value="algorithms">Алгоритмы и структуры данных</option>
                            <option value="databases">Базы данных</option>
                            <option value="networks">Компьютерные сети</option>
                            <option value="english">Английский язык</option>
                            <option value="economics">Экономика</option>
                        </select>
                        <span class="modal-caret">▾</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn btn-back" id="btnBack">Вернуться</button>
                <button type="button" class="modal-btn btn-clear" id="btnClear">Очистить выбор</button>
                <button type="button" class="modal-btn btn-confirm" id="btnConfirm">Подтвердить выбор</button>
            </div>
        </div>
    </div>

    <script>
        // Данные для хранения выбранных дисциплин
        const groupSubjects = {};
        
        // Текущая выбранная группа
        let currentGroupId = '';

        document.addEventListener('DOMContentLoaded', function() {
            const planRadios = document.querySelectorAll('.plan-square input[type="radio"]');
            const form = document.getElementById('mainForm');
            
            planRadios.forEach(radio => {
                radio.addEventListener('click', function(e) {
                    // Получаем ID группы из name атрибута
                    const name = this.getAttribute('name');
                    const groupId = name.replace('plan_', '');
                    currentGroupId = groupId;
                    
                    // Обновляем заголовок модального окна
                    document.getElementById('modalGroupId').textContent = groupId;
                    
                    // Восстанавливаем ранее выбранные дисциплины, если они есть
                    if (groupSubjects[groupId]) {
                        document.getElementById('subject1').value = groupSubjects[groupId][0] || '';
                        document.getElementById('subject2').value = groupSubjects[groupId][1] || '';
                    } else {
                        // Сбрасываем выбор
                        document.getElementById('subject1').value = '';
                        document.getElementById('subject2').value = '';
                    }
                    
                    // Показываем модальное окно
                    document.getElementById('subjectModal').style.display = 'flex';
                });
            });
            
            // Обработчики кнопок модального окна
            document.getElementById('btnConfirm').addEventListener('click', function() {
                const subject1 = document.getElementById('subject1').value;
                const subject2 = document.getElementById('subject2').value;
                
                // Проверяем, что хотя бы одна дисциплина выбрана
                if (!subject1 && !subject2) {
                    alert('Пожалуйста, выберите хотя бы одну дисциплину');
                    return;
                }
                
                // Сохраняем выбранные дисциплины
                groupSubjects[currentGroupId] = [subject1, subject2];
                
                // Закрываем модальное окно
                document.getElementById('subjectModal').style.display = 'none';
                
                console.log(`Для группы ${currentGroupId} выбраны дисциплины:`, subject1, subject2);
            });
            
            document.getElementById('btnClear').addEventListener('click', function() {
                // Очищаем выбор
                document.getElementById('subject1').value = '';
                document.getElementById('subject2').value = '';
            });
            
            document.getElementById('btnBack').addEventListener('click', function() {
                // Снимаем выделение с радио-кнопки
                const radio = document.querySelector(`input[name="plan_${currentGroupId}"]:checked`);
                if (radio) {
                    radio.checked = false;
                }
                
                // Закрываем модальное окно
                document.getElementById('subjectModal').style.display = 'none';
            });
            
            // Закрытие модального окна при клике на оверлей
            document.getElementById('subjectModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Обработчик отправки формы
            form.addEventListener('submit', function(e) {
                // Проверяем, что для каждой запланированной группы выбраны дисциплины
                const plannedGroups = document.querySelectorAll('.plan-square input[type="radio"]:checked');
                let allValid = true;
                const missingSubjects = [];
                
                plannedGroups.forEach(radio => {
                    const name = radio.getAttribute('name');
                    const groupId = name.replace('plan_', '');
                    
                    if (!groupSubjects[groupId] || (!groupSubjects[groupId][0] && !groupSubjects[groupId][1])) {
                        allValid = false;
                        missingSubjects.push(groupId);
                    }
                });
                
                if (!allValid) {
                    e.preventDefault();
                    alert(`Для следующих групп не выбраны дисциплины: ${missingSubjects.join(', ')}`);
                    return false;
                }
                
                // Добавляем скрытые поля с выбранными дисциплинами
                for (const [groupId, subjects] of Object.entries(groupSubjects)) {
                    // Удаляем старые поля, если они есть
                    const oldField1 = document.querySelector(`input[name="subjects_${groupId}_1"]`);
                    const oldField2 = document.querySelector(`input[name="subjects_${groupId}_2"]`);
                    if (oldField1) oldField1.remove();
                    if (oldField2) oldField2.remove();
                    
                    const subject1Input = document.createElement('input');
                    subject1Input.type = 'hidden';
                    subject1Input.name = `subjects_${groupId}_1`;
                    subject1Input.value = subjects[0] || '';
                    
                    const subject2Input = document.createElement('input');
                    subject2Input.type = 'hidden';
                    subject2Input.name = `subjects_${groupId}_2`;
                    subject2Input.value = subjects[1] || '';
                    
                    this.appendChild(subject1Input);
                    this.appendChild(subject2Input);
                }
                
                return true;
            });
        });
    </script>
</body>
</html>
